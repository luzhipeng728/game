# 随从选择系统架构总结

## 🎯 系统概览

这是一个全新的游戏机制，改变了传统的自由聊天模式，引入了限制性选择和评分系统。

## 🏗️ 架构组件

### 1. 核心模型层 (`models.py`)
- **GamePhase**: 游戏阶段枚举（自由聊天 → 随从选择 → 游戏结束）
- **FollowerChoice**: 随从选择数据结构
- **GameResult**: 游戏结果枚举（成功/失败/平局）
- **GameState**: 扩展的游戏状态管理
- **EvaluatorAgent**: 新增的评分智能体

### 2. 智能体层
- **FollowerAgent**: 增强的随从智能体，负责生成选择
- **EvaluatorAgent**: 专门的评估智能体，负责打分
- **AgentCoordinator**: 升级的协调器，支持阶段管理

### 3. WebSocket服务层
- 新增随从选择相关的消息类型
- 随从选择阶段的处理逻辑
- 自动触发选择机制
- 游戏结束处理

### 4. 前端界面层
- 选择模式UI（替代自由输入）
- 实时数值显示
- 游戏进度指示器
- 结果展示界面

## 🔄 系统流程

```
开始游戏
    ↓
初始化场景和角色
    ↓
自由聊天阶段 ← ─ ─ ─ ─ ─ ─ ┐
    ↓                     │
检测触发条件               │
    ↓                     │
随从选择阶段               │
    ├─ 生成3个AI选择       │
    ├─ 显示自定义输入选项   │
    ├─ 用户做出选择        │
    ├─ 评估和应用效果      │
    └─ NPC反应            │
    ↓                     │
检查游戏结束条件            │
    ├─ 未结束 ─ ─ ─ ─ ─ ─ ┘
    └─ 已结束
    ↓
计算最终结果和奖励
    ↓
显示游戏总结
    ↓
结束
```

## ⚙️ 关键机制

### 选择生成机制
1. **智能体分析**: 随从智能体分析当前场景和对话历史
2. **上下文感知**: 根据当前数值和轮数生成合适的选择
3. **风险分级**: 每个选择都有1-5的风险等级
4. **效果预期**: 明确告知每个选择的预期数值变化

### 评估系统
1. **质量评分**: 1-10分的质量评估
2. **内容分析**: 检测不当内容（粗口等）并降分
3. **情境适应**: 根据当前游戏状态调整评分标准
4. **动态反馈**: 评分结果影响后续NPC反应

### 游戏进度控制
1. **轮数限制**: 最多5轮随从行动
2. **触发条件**: 智能检测何时应该进入选择阶段
3. **阶段管理**: 清晰的游戏阶段转换
4. **结束判断**: 多种游戏结束条件

## 🎮 用户体验

### 对随从玩家
- **受限输入**: 不能自由聊天，只能选择或自定义输入
- **战略选择**: 需要考虑风险和回报
- **实时反馈**: 立即看到选择的效果
- **进度感知**: 清楚知道剩余轮数和当前状态

### 对其他玩家
- **观察模式**: 可以观看随从的选择过程
- **自然互动**: 仍可以自由聊天
- **剧情参与**: 智能体会根据随从选择调整反应

## 📊 数值系统

### 核心数值
- **暧昧度**: 与目标的亲密程度
- **危险度**: 被发现的风险
- **紧张度**: 当前环境的紧张程度
- **金钱消费**: 花费的金钱

### 胜利条件
- 暧昧度达到目标值（如60+）
- 危险度保持在安全范围（如80以下）
- 在轮数限制内完成任务

### 失败条件
- 危险度过高被发现
- 轮数用完任务未完成
- 重要数值降到负值

## 🔧 技术实现

### 消息类型
```python
FOLLOWER_CHOICE_REQUEST = "follower_choice_request"
FOLLOWER_CHOICE_RESPONSE = "follower_choice_response"
GAME_PHASE_CHANGE = "game_phase_change"
GAME_END = "game_end"
```

### API端点
```python
POST /rooms/{room_id}/follower_choice/trigger  # 手动触发选择
```

### WebSocket事件流
1. 用户消息 → 检测触发条件
2. 触发选择 → 生成选择项
3. 广播选择请求 → 用户选择
4. 处理选择 → 应用效果
5. 生成反应 → 继续游戏

## 🎯 优势特性

### 1. 限制性游戏性
- 防止随从玩家破坏剧情
- 提供结构化的游戏体验
- 增加策略思考的深度

### 2. 智能化选择
- AI生成的选择贴合情境
- 动态调整选择难度
- 提供风险-回报平衡

### 3. 即时反馈
- 选择后立即看到效果
- 数值变化可视化
- NPC反应增强沉浸感

### 4. 可扩展性
- 可以轻松添加新的数值类型
- 支持不同的游戏场景
- 评估系统可以持续优化

## 🛠️ 部署和测试

### 演示文件
- `demo_complete_follower_system.py`: 完整系统演示
- `demo_follower_choice_system.py`: 选择机制演示

### 测试方法
1. 运行演示文件查看系统工作流程
2. 启动WebSocket服务器进行实际测试
3. 使用浏览器客户端测试用户体验

### 配置要点
- 确保所有智能体都已正确初始化
- 检查游戏状态的正确传递
- 验证WebSocket消息的正确处理

## 🔮 未来扩展

### 短期优化
- 添加更多选择类型
- 优化评分算法
- 增强UI交互效果

### 长期规划
- 支持多个随从角色
- 添加更复杂的任务类型
- 实现机器学习的选择生成

---

这个系统彻底改变了游戏的交互模式，从自由聊天转向结构化选择，为玩家提供了更有策略性和挑战性的游戏体验。