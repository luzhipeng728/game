# 🏰 苏丹的游戏 - 多智能体卡牌系统

基于CrewAI框架构建的多智能体对话系统，实现《苏丹的游戏》中的妓院场景卡牌任务模拟。

## 📋 功能特点

### 🎭 多智能体系统
- **随从智能体**: 忠诚的执行者，携带卡牌任务前往目标场景
- **妓女智能体**: 魅惑的交际者，展现风情并试探客人意图
- **老鸨智能体**: 精明的管理者，保护生意和姑娘们的安全
- **旁白智能体**: 全知的叙述者，控制故事节奏和场景变化

### 🎴 卡牌任务系统
- **四种类型**: 纵欲、奢靡、征服、杀戮
- **四个品级**: 岩石、青铜、白银、黄金
- **16种组合**: 不同类型和品级的卡牌有不同的任务要求和奖励

### 🎲 游戏机制
- **属性系统**: 魅力、智慧、体魄、战斗、社交、隐匿
- **关系系统**: 角色间的好感度和关系变化
- **场景数值**: 紧张度、暧昧度、危险度、金钱消费
- **骰子检定**: 随机性和技能判定
- **实时互动**: 智能体间的自然对话流程

### 🛠️ 自定义工具
- **关系管理工具**: 追踪角色关系变化
- **场景数值工具**: 管理环境氛围
- **骰子检定工具**: 处理随机事件
- **卡牌使用工具**: 执行任务结果
- **对话记录工具**: 保存重要信息

## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆或下载项目
# 确保你已在正确的目录中

# 安装依赖
pip install -r requirements.txt

# 或使用uv（推荐）
uv install
```

### 2. 配置API密钥

复制环境变量模板：
```bash
cp .env.example .env
```

编辑 `.env` 文件，设置你的OpenAI API密钥：
```bash
OPENAI_API_KEY=你的_openai_api_密钥
```

### 3. 运行测试

验证系统是否正常工作：
```bash
python test_system.py
```

### 4. 启动应用

```bash
streamlit run sultans_game_app.py
```

应用将在浏览器中打开，默认地址：`http://localhost:8501`

## 📖 使用指南

### 基本流程

1. **设置API密钥**: 在侧边栏输入你的OpenAI API密钥
2. **生成卡牌**: 选择卡牌类型和品级，或使用教学卡牌
3. **开始对话**: 点击"开始场景对话"按钮
4. **观察结果**: 查看智能体间的对话和场景变化
5. **查看状态**: 检查角色关系和场景数值的变化

### 卡牌类型说明

#### 🔥 纵欲卡
- **目的**: 追寻新的情欲放纵
- **限制**: 不能连续作用于同一角色
- **风险**: 可能引起妻子的不满

#### 💎 奢靡卡
- **目的**: 挥霍大量金钱
- **方式**: 大搞基建、购买奢侈品
- **收益**: 获得魅力值和声望

#### ⚔️ 征服卡
- **目的**: 参与冒险挑战
- **风险**: 失败损失大量金钱和声望
- **收益**: 成功获得大量声望和其他奖励

#### 🗡️ 杀戮卡
- **目的**: 取走一条人命
- **风险**: 小概率被反杀
- **后果**: 影响声望和关系

### 品级系统

- **岩石级**: 基础任务，风险较低
- **青铜级**: 中等难度，需要一定技巧
- **白银级**: 高难度，需要良好属性
- **黄金级**: 极高风险，但奖励丰厚

## 🎮 系统架构

### 📁 项目结构

```
sultans_game/
├── __init__.py          # 包初始化
├── models.py            # 数据模型（角色、卡牌、场景）
├── agents.py            # 智能体定义和游戏主控制器
├── cards.py             # 卡牌生成器
└── tools.py             # 自定义工具集合

sultans_game_app.py      # Streamlit网页界面
test_system.py           # 系统测试脚本
.env.example             # 环境变量模板
README_SULTANS_GAME.md   # 项目说明文档
```

### 🧠 智能体设计

#### 随从智能体
- **角色**: 执行主人的任务
- **工具**: 骰子检定、对话记录、关系管理
- **特点**: 谨慎、忠诚、善于察言观色

#### 妓女智能体
- **角色**: 吸引客人获得利益
- **特点**: 妩媚、聪慧、善于交际
- **策略**: 试探财力、调整态度、保护安全

#### 老鸨智能体
- **角色**: 管理妓院业务
- **特点**: 精明、经验丰富、保护手下
- **职责**: 评估客人、协调价格、维护秩序

#### 旁白智能体
- **角色**: 故事叙述者和控制者
- **工具**: 关系管理、场景数值、卡牌使用、骰子检定
- **职责**: 描述场景、记录变化、推动剧情

### 🔧 工具系统

每个智能体可以使用相应的工具来影响游戏状态：

- **关系工具**: 修改角色间的好感度
- **场景工具**: 调整环境氛围数值
- **骰子工具**: 进行随机判定
- **卡牌工具**: 处理任务执行结果
- **记录工具**: 保存重要对话信息

## 🎯 游戏流程示例

### 典型对话流程

1. **场景开始**: 旁白描述妓院环境和氛围
2. **角色登场**: 随从进入，与妓女和老鸨交流
3. **试探阶段**: 各角色展现性格，试探对方意图
4. **关系发展**: 通过对话建立或改变关系
5. **关键时刻**: 决定是否使用卡牌或采取行动
6. **结果处理**: 旁白总结变化并提供下一步建议

### 数值变化示例

```
初始状态:
- 暧昧度: 0/100
- 紧张度: 0/100
- 危险度: 0/100

对话过程中:
- 妓女展现魅力 → 暧昧度 +15
- 随从试探意图 → 紧张度 +10
- 老鸨介入评估 → 危险度 +5

最终状态:
- 暧昧度: 15/100
- 紧张度: 10/100
- 危险度: 5/100
```

## ⚙️ 配置选项

### 环境变量

```bash
# 必需
OPENAI_API_KEY=你的API密钥

# 可选
OPENAI_MODEL=gpt-4o-mini          # 使用的模型
OPENAI_API_BASE=https://...       # API基础URL
```

### 智能体参数

可以在 `agents.py` 中调整：
- **temperature**: 创造性程度 (0.0-1.0)
- **model**: 使用的语言模型
- **max_rounds**: 最大对话轮数

### 卡牌配置

可以在 `cards.py` 中修改：
- 添加新的卡牌类型
- 修改任务描述和奖励
- 调整难度和风险级别

## 🐛 故障排除

### 常见问题

1. **模块导入失败**
   ```bash
   # 解决方案：确保所有依赖已安装
   pip install -r requirements.txt
   ```

2. **API密钥错误**
   ```bash
   # 检查.env文件中的API密钥设置
   cat .env
   ```

3. **对话执行失败**
   - 检查网络连接
   - 验证API密钥有效性
   - 确认OpenAI账户有足够余额

4. **Streamlit启动问题**
   ```bash
   # 尝试指定端口
   streamlit run sultans_game_app.py --server.port 8502
   ```

### 调试模式

启用详细日志：
```python
# 在agents.py中设置
verbose=True
```

## 🔄 扩展开发

### 添加新场景

1. 在 `models.py` 中定义新的场景类型
2. 在 `agents.py` 中创建对应的智能体
3. 在 `tools.py` 中添加场景特定的工具
4. 更新界面以支持新场景

### 添加新卡牌

1. 在 `cards.py` 中定义新的卡牌数据
2. 更新 `CardType` 枚举
3. 调整智能体的backstory以处理新任务

### 添加新工具

```python
from crewai.tools import tool

@tool("new_tool")
def new_tool(parameter: str) -> str:
    """工具描述"""
    # 工具逻辑
    return result
```

## 📊 性能优化

### API调用优化
- 使用缓存减少重复调用
- 选择合适的模型（gpt-4o-mini性价比高）
- 控制对话长度避免token浪费

### 内存管理
- 定期清理对话历史
- 限制同时处理的任务数量
- 使用数据压缩存储游戏状态

## 🤝 贡献指南

欢迎提交Issues和Pull Requests来改进这个项目！

1. Fork项目
2. 创建功能分支
3. 提交更改
4. 发起Pull Request

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 🙏 致谢

- [CrewAI](https://docs.crewai.com/) - 多智能体框架
- [Streamlit](https://streamlit.io/) - Web界面框架
- [OpenAI](https://openai.com/) - 语言模型API
- 《苏丹的游戏》原作 - 游戏设计灵感

---

*🏰 愿你在苏丹的游戏中找到智慧与勇气！*